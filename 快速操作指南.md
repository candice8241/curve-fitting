# ğŸš€ PyInstaller æ„å»ºå¿«é€ŸæŒ‡å—

## âš ï¸ ä½ é‡åˆ°çš„ä¸¤ä¸ªé”™è¯¯

### é”™è¯¯ 1ï¼šæƒé™é”™è¯¯
```
PermissionError: [WinError 5] æ‹’ç»è®¿é—®ã€‚
```
**åŸå› ï¼š**ç¨‹åºæ­£åœ¨è¿è¡Œï¼Œæˆ–è€… dist ç›®å½•è¢«å ç”¨

### é”™è¯¯ 2ï¼šå‘½ä»¤å‚æ•°é”™è¯¯
```
ERROR: option(s) not allowed: --collect-all
makespec options not valid when a .spec file is given
```
**åŸå› ï¼š**ä½¿ç”¨ `.spec` æ–‡ä»¶æ—¶ï¼Œ**ä¸èƒ½**ä½¿ç”¨ `--collect-all` ç­‰å‘½ä»¤è¡Œå‚æ•°ï¼

---

## âœ… æ­£ç¡®çš„æ“ä½œæ­¥éª¤

### ğŸ“¥ ç¬¬ä¸€æ­¥ï¼šä¸‹è½½æ–‡ä»¶

ä» GitHub ä¸‹è½½è¿™äº›æ–‡ä»¶åˆ°ä½ çš„é¡¹ç›®ç›®å½•ï¼š
```
D:\HEPS\ID31\dioptas_data\github_felicity\batch\HP_full_package\
```

éœ€è¦çš„æ–‡ä»¶ï¼š
- âœ… `XRD_PostProcessing_V2.spec`
- âœ… `pyi_rth_pyFAI.py`
- âœ… `clean_build.bat` ï¼ˆæ¸…ç†è„šæœ¬ï¼‰
- âœ… `build_method1.bat` ï¼ˆæ–¹æ³•ä¸€æ„å»ºè„šæœ¬ï¼‰
- âœ… `build_method2.bat` ï¼ˆæ–¹æ³•äºŒæ„å»ºè„šæœ¬ï¼‰

---

### ğŸ› ï¸ ç¬¬äºŒæ­¥ï¼šè§£å†³æƒé™é—®é¢˜

#### æ–¹æ³• Aï¼šä½¿ç”¨æ¸…ç†è„šæœ¬ï¼ˆæ¨èï¼‰
```bash
# åŒå‡»è¿è¡Œ
clean_build.bat
```

#### æ–¹æ³• Bï¼šæ‰‹åŠ¨æ¸…ç†
```bash
# 1. å…³é—­æ‰€æœ‰ XRD_PostProcessing.exe è¿›ç¨‹
# åœ¨ä»»åŠ¡ç®¡ç†å™¨ä¸­ç»“æŸè¿›ç¨‹ï¼Œæˆ–è€…è¿è¡Œï¼š
taskkill /F /IM XRD_PostProcessing.exe

# 2. æ‰‹åŠ¨åˆ é™¤è¿™äº›ç›®å½•
rmdir /s /q dist
rmdir /s /q build
```

#### æ–¹æ³• Cï¼šåœ¨å‘½ä»¤è¡Œä¸­ä¸€æ­¥å®Œæˆ
```bash
taskkill /F /IM XRD_PostProcessing.exe & timeout /t 2 & rmdir /s /q dist & rmdir /s /q build
```

---

### ğŸ¯ ç¬¬ä¸‰æ­¥ï¼šé€‰æ‹©æ„å»ºæ–¹æ³•å¹¶æ‰§è¡Œ

## æ–¹æ³•ä¸€ï¼šRuntime Hookï¼ˆæ¨èï¼‰â­â­â­

**ä½¿ç”¨æ–‡ä»¶ï¼š**
- `XRD_PostProcessing_V2.spec`
- `pyi_rth_pyFAI.py`

**æ‰§è¡Œæ–¹å¼ï¼š**

#### é€‰é¡¹ Aï¼šåŒå‡»è¿è¡Œè„šæœ¬ï¼ˆæœ€ç®€å•ï¼‰
```bash
åŒå‡»è¿è¡Œï¼š build_method1.bat
```

#### é€‰é¡¹ Bï¼šæ‰‹åŠ¨è¾“å…¥å‘½ä»¤
```bash
# æ‰“å¼€å‘½ä»¤è¡Œï¼Œè¿›å…¥é¡¹ç›®ç›®å½•
cd D:\HEPS\ID31\dioptas_data\github_felicity\batch\HP_full_package

# è¿è¡Œæ„å»ºå‘½ä»¤ï¼ˆæ³¨æ„ï¼šä½¿ç”¨ spec æ–‡ä»¶æ—¶ï¼Œä¸è¦åŠ  --collect-allï¼ï¼‰
pyinstaller XRD_PostProcessing_V2.spec --clean
```

**âœ“ æ­£ç¡®å‘½ä»¤ï¼š**
```bash
pyinstaller XRD_PostProcessing_V2.spec --clean
```

**âœ— é”™è¯¯å‘½ä»¤ï¼ˆä½ åˆšæ‰ç”¨çš„ï¼‰ï¼š**
```bash
pyinstaller XRD_PostProcessing_V2.spec --collect-all pyFAI --clean  # â† é”™è¯¯ï¼
```

---

## æ–¹æ³•äºŒï¼š--collect-allï¼ˆæœ€ç®€å•ï¼‰â­â­

**ä¸ä½¿ç”¨ spec æ–‡ä»¶ï¼Œç›´æ¥ç”¨å‘½ä»¤è¡Œå‚æ•°**

#### é€‰é¡¹ Aï¼šåŒå‡»è¿è¡Œè„šæœ¬
```bash
åŒå‡»è¿è¡Œï¼š build_method2.bat
```

#### é€‰é¡¹ Bï¼šæ‰‹åŠ¨è¾“å…¥å‘½ä»¤
```bash
cd D:\HEPS\ID31\dioptas_data\github_felicity\batch\HP_full_package

# ä¸è¦ç”¨ .spec æ–‡ä»¶ï¼Œç›´æ¥æ„å»º
pyinstaller main.py --collect-all pyFAI --collect-all fabio --name XRD_PostProcessing --clean --noconsole
```

---

## ğŸ“Š ä¸¤ç§æ–¹æ³•å¯¹æ¯”

| ç‰¹æ€§ | æ–¹æ³•ä¸€ï¼šRuntime Hook | æ–¹æ³•äºŒï¼š--collect-all |
|------|---------------------|----------------------|
| ä½¿ç”¨æ–‡ä»¶ | spec + py æ–‡ä»¶ | åªç”¨å‘½ä»¤è¡Œ |
| å‘½ä»¤ | `pyinstaller *.spec --clean` | `pyinstaller main.py --collect-all ...` |
| æ‰“åŒ…ä½“ç§¯ | ä¸­ç­‰ | è¾ƒå¤§ |
| æˆåŠŸç‡ | â­â­â­â­â­ | â­â­â­â­ |
| æ„å»ºé€Ÿåº¦ | ä¸­ç­‰ | è¾ƒæ…¢ |
| é€‚åˆåœºæ™¯ | ç²¾ç¡®æ§åˆ¶ | å¿«é€Ÿæµ‹è¯• |

---

## ğŸ” ç¬¬å››æ­¥ï¼šéªŒè¯æ„å»ºç»“æœ

### 1. æ£€æŸ¥ exe æ–‡ä»¶æ˜¯å¦å­˜åœ¨
```bash
dir dist\XRD_PostProcessing\XRD_PostProcessing.exe
```

### 2. æ£€æŸ¥ pyFAI æ¨¡å—æ˜¯å¦æ‰“åŒ…
```bash
dir /s dist\XRD_PostProcessing\_internal\pyFAI\ext\splitPixelFullCSC.pyd
```

### 3. è¿è¡Œç¨‹åºæµ‹è¯•
```bash
cd dist\XRD_PostProcessing
XRD_PostProcessing.exe
```

---

## ğŸ†˜ æ•…éšœæ’æŸ¥

### é—®é¢˜ 1ï¼šä»ç„¶æŠ¥æƒé™é”™è¯¯
```bash
# æ–¹æ³• 1ï¼šé‡å¯èµ„æºç®¡ç†å™¨
taskkill /F /IM explorer.exe & start explorer.exe

# æ–¹æ³• 2ï¼šä½¿ç”¨ç®¡ç†å‘˜æƒé™
# å³é”®"å‘½ä»¤æç¤ºç¬¦" â†’ "ä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡Œ"
# ç„¶åå†è¿è¡Œæ„å»ºå‘½ä»¤

# æ–¹æ³• 3ï¼šé‡å¯ç”µè„‘ï¼ˆæœ€æœ‰æ•ˆï¼‰
```

### é—®é¢˜ 2ï¼šæ‰¾ä¸åˆ° spec æ–‡ä»¶
```bash
# ç¡®è®¤æ–‡ä»¶åœ¨å½“å‰ç›®å½•
dir *.spec

# å¦‚æœæ²¡æœ‰ï¼Œè¯´æ˜æ–‡ä»¶æ²¡æœ‰ä¸‹è½½åˆ°æ­£ç¡®ä½ç½®
# éœ€è¦é‡æ–°ä» GitHub ä¸‹è½½
```

### é—®é¢˜ 3ï¼šä»ç„¶æœ‰ pyFAI å¯¼å…¥é”™è¯¯

#### å°è¯•å¯ç”¨æ§åˆ¶å°çœ‹è¯¦ç»†é”™è¯¯
ä¸´æ—¶ä¿®æ”¹ `XRD_PostProcessing_V2.spec`ï¼š
```python
# æ‰¾åˆ°è¿™ä¸€è¡Œï¼š
console=False,

# æ”¹ä¸ºï¼š
console=True,
```

ç„¶åé‡æ–°æ„å»ºï¼Œè¿è¡Œæ—¶ä¼šæ˜¾ç¤ºè¯¦ç»†é”™è¯¯ä¿¡æ¯ã€‚

#### å°è¯•ç»„åˆæ–¹æ³•
å¦‚æœæ–¹æ³•ä¸€å’Œæ–¹æ³•äºŒéƒ½å¤±è´¥ï¼Œå¯ä»¥å°è¯•ä¿®æ”¹ spec æ–‡ä»¶ï¼Œæ‰‹åŠ¨æ·»åŠ  pyFAI çš„æ‰€æœ‰äºŒè¿›åˆ¶æ–‡ä»¶ï¼š

```python
# åœ¨ Analysis ä¸­æ·»åŠ ï¼š
import site
import os

pyfai_path = os.path.join(site.getsitepackages()[0], 'pyFAI', 'ext')

a = Analysis(
    # ... å…¶ä»–å‚æ•° ...
    binaries=[
        (os.path.join(pyfai_path, '*.pyd'), 'pyFAI/ext'),  # Windows
        # æˆ–
        (os.path.join(pyfai_path, '*.so'), 'pyFAI/ext'),   # Linux
    ],
    # ... å…¶ä»–å‚æ•° ...
)
```

---

## ğŸ¯ æ¨èæ“ä½œæµç¨‹ï¼ˆæœ€ç¨³å¦¥ï¼‰

```bash
# 1. è¿›å…¥é¡¹ç›®ç›®å½•
cd D:\HEPS\ID31\dioptas_data\github_felicity\batch\HP_full_package

# 2. æ¸…ç†ï¼ˆåŒå‡»è¿è¡Œï¼‰
clean_build.bat

# 3. æ„å»ºæ–¹æ³•ä¸€ï¼ˆåŒå‡»è¿è¡Œï¼‰
build_method1.bat

# 4. å¦‚æœå¤±è´¥ï¼Œå°è¯•æ–¹æ³•äºŒï¼ˆåŒå‡»è¿è¡Œï¼‰
build_method2.bat

# 5. æµ‹è¯•è¿è¡Œ
cd dist\XRD_PostProcessing
XRD_PostProcessing.exe
```

---

## ğŸ“‹ å¿«é€Ÿå‘½ä»¤å¤‡å¿˜

### å®Œæ•´æµç¨‹ï¼ˆå¤åˆ¶ç²˜è´´ï¼‰
```bash
REM è¿›å…¥é¡¹ç›®ç›®å½•
cd D:\HEPS\ID31\dioptas_data\github_felicity\batch\HP_full_package

REM æ¸…ç†æ—§æ–‡ä»¶
taskkill /F /IM XRD_PostProcessing.exe
rmdir /s /q dist
rmdir /s /q build

REM æ–¹æ³•ä¸€ï¼šRuntime Hook
pyinstaller XRD_PostProcessing_V2.spec --clean

REM æˆ–è€…æ–¹æ³•äºŒï¼š--collect-all
pyinstaller main.py --collect-all pyFAI --collect-all fabio --name XRD_PostProcessing --clean --noconsole

REM æµ‹è¯•è¿è¡Œ
cd dist\XRD_PostProcessing
XRD_PostProcessing.exe
```

---

## âš¡ è®°ä½è¿™äº›è¦ç‚¹

1. **ä½¿ç”¨ .spec æ–‡ä»¶æ—¶**ï¼š
   - âœ… `pyinstaller file.spec --clean`
   - âœ— `pyinstaller file.spec --collect-all pyFAI`ï¼ˆé”™è¯¯ï¼ï¼‰

2. **ä½¿ç”¨ --collect-all æ—¶**ï¼š
   - âœ… `pyinstaller main.py --collect-all pyFAI`
   - âœ— `pyinstaller file.spec --collect-all pyFAI`ï¼ˆé”™è¯¯ï¼ï¼‰

3. **æƒé™é”™è¯¯æ—¶**ï¼š
   - å…ˆå…³é—­æ‰€æœ‰ `.exe` è¿›ç¨‹
   - åˆ é™¤ `dist` å’Œ `build` ç›®å½•
   - ä½¿ç”¨ç®¡ç†å‘˜æƒé™è¿è¡Œå‘½ä»¤è¡Œ

4. **ä¼˜å…ˆçº§**ï¼š
   - å…ˆè¯•æ–¹æ³•ä¸€ï¼ˆRuntime Hookï¼‰
   - å¦‚æœå¤±è´¥å†è¯•æ–¹æ³•äºŒï¼ˆ--collect-allï¼‰
   - å¦‚æœè¿˜å¤±è´¥ï¼Œå¯ç”¨ `console=True` æŸ¥çœ‹è¯¦ç»†é”™è¯¯

---

**ç¥ä½ æˆåŠŸï¼** ğŸ‰

å¦‚æœè¿˜æœ‰é—®é¢˜ï¼Œè¯·æä¾›ï¼š
1. ä½¿ç”¨çš„æ˜¯å“ªç§æ–¹æ³•
2. å®Œæ•´çš„é”™è¯¯ä¿¡æ¯
3. Python ç‰ˆæœ¬ã€PyInstaller ç‰ˆæœ¬ã€pyFAI ç‰ˆæœ¬
