# 晶系判断和相变识别程序使用说明

## 简介

本程序用于从高压XRD实验数据中自动识别相变点，统计新峰数量，并判断不同压力下材料所属的晶系。

## 功能特点

1. **自动相变识别**：根据新峰出现自动识别相变压力点
2. **新峰统计**：智能统计相变后的新峰数量
3. **晶系判断**：支持7种晶系的自动识别和晶胞参数计算
   - 立方晶系（FCC, BCC, SC）
   - 六方晶系（HCP）
   - 四方晶系
   - 正交晶系
   - 单斜晶系
   - 三斜晶系
4. **晶胞参数计算**：自动计算最佳拟合的晶胞参数

## 安装依赖

```bash
pip install numpy pandas scipy matplotlib
```

## 输入文件格式

### CSV文件要求

- **File列**：压力值（GPa）或包含压力信息的文件名
- **Center列**：峰位（2theta角度，单位：度）
- **空行分隔**：不同压力点之间用空行分隔

### 示例CSV格式

```csv
File,Peak #,Center,Amplitude,Sigma,Gamma,Eta
5.2,1,38.456,1250.3,0.125,0.098,0.45
5.2,2,44.712,980.5,0.138,0.102,0.48

8.5,1,38.234,1180.5,0.128,0.100,0.46
8.5,2,44.523,920.3,0.142,0.105,0.49

12.3,1,38.012,1120.8,0.132,0.103,0.47
12.3,2,44.334,880.7,0.145,0.108,0.50
```

## 使用方法

### 基本用法

```bash
python phase_transition_analysis.py <csv_file_path>
```

### 示例

```bash
python phase_transition_analysis.py example_peaks.csv
```

## 配置参数

在代码顶部可以调整以下参数：

```python
# X射线波长 (Å)
WAVELENGTH = 0.6199  # 根据实际实验条件修改

# 识别相变点的峰位容差 (度)
PEAK_TOLERANCE_1 = 0.3

# 确定新峰数目的容差 (度)
PEAK_TOLERANCE_2 = 0.2

# 后续压力点围绕新峰的容差 (度)
PEAK_TOLERANCE_3 = 0.15

# 用于确定新峰数目稳定的压力点数量
N_PRESSURE_POINTS = 4
```

### 参数说明

- **WAVELENGTH**：根据你的同步辐射光源或实验室X射线源调整
  - Cu Kα: 1.5406 Å
  - Mo Kα: 0.7107 Å
  - 同步辐射：根据实际能量计算（λ = 12.398 / E(keV) Å）

- **PEAK_TOLERANCE_1**：相变点识别的敏感度
  - 值越小，识别越敏感
  - 建议范围：0.2 - 0.5度

- **PEAK_TOLERANCE_2**：新峰数量统计的精度
  - 用于判断峰是否为"新峰"
  - 建议范围：0.15 - 0.3度

- **PEAK_TOLERANCE_3**：后续分析的匹配精度
  - 用于追踪新峰的演化
  - 建议范围：0.1 - 0.2度

- **N_PRESSURE_POINTS**：判断新峰数量稳定所需的压力点数
  - 建议值：3-5个点

## 算法原理

### 1. 相变点识别

程序会按压力从小到大逐个比较相邻压力点：
- 如果在当前压力点发现了不在前一压力点PEAK_TOLERANCE_1范围内的新峰
- 则将该压力点标记为相变点

### 2. 新峰数量统计

从相变点开始，程序会：
1. 统计后续N个压力点的新峰数量
2. 如果最后3个点的新峰数量相同，认为已稳定
3. 返回稳定的新峰数量

### 3. 晶系判断逻辑

根据新峰数量筛选可能的晶系：
- **1个新峰**：只检查立方晶系（FCC/BCC/SC）
- **2个新峰**：检查立方、六方、四方晶系
- **3个新峰**：检查立方、六方、四方、正交晶系
- **4个新峰**：检查除三斜外的所有晶系
- **6个及以上新峰**：检查所有晶系

### 4. 晶胞参数计算

对每个可能的晶系：
1. 使用Bragg定律将2theta转换为d间距
2. 根据晶系的d间距公式和hkl指标，通过最小二乘法拟合晶胞参数
3. 计算拟合残差
4. 选择残差最小的晶系作为最佳匹配

### 各晶系d间距公式

**立方晶系：**
```
1/d² = (h² + k² + l²) / a²
```

**六方晶系：**
```
1/d² = 4/3 · (h² + hk + k²) / a² + l² / c²
```

**四方晶系：**
```
1/d² = (h² + k²) / a² + l² / c²
```

**正交晶系：**
```
1/d² = h²/a² + k²/b² + l²/c²
```

**单斜晶系：**
```
1/d² = [h²/a² + k²sin²β/b² + l²/c² - 2hlcosβ/(ac)] / sin²β
```

## 输出结果

### 屏幕输出

程序会在屏幕上输出：
1. 读取的压力点数量和每个压力点的峰数
2. 识别到的相变压力点
3. 相变前后的晶系判断结果
4. 晶胞参数和拟合质量

### JSON文件输出

程序会自动生成一个JSON文件（`<输入文件名>_phase_analysis.json`），包含：
- 相变压力点
- 相变前的晶系和晶胞参数
- 相变后每个压力点的详细分析结果
  - 新峰列表
  - 原峰列表
  - 新相晶系
  - 晶胞参数
  - 拟合质量

### 输出示例

```
======================================================================
晶系判断和相变识别分析
======================================================================

[步骤 1] 读取CSV数据...
  共读取 8 个压力点
    5.20 GPa: 5 个峰
    8.50 GPa: 5 个峰
    12.30 GPa: 5 个峰
    15.80 GPa: 6 个峰
    ...

[步骤 2] 识别相变点...

>>> 发现相变点：15.80 GPa

[步骤 3] 分析相变前的晶系...
  相变前使用 15 个峰进行晶系判断

开始晶系判断，可用峰数：15
  Face-Centered Cubic (FCC): a=4.0521 Å, 残差=0.000234
  Body-Centered Cubic (BCC): a=3.2145 Å, 残差=0.001567
  ...

>>> 最佳匹配晶系：Face-Centered Cubic (FCC)
    晶胞参数：{'a': 4.0521}
    拟合残差：0.000234

[步骤 4] 分析相变后的新峰...
  压力 15.80 GPa: 1 个新峰
  压力 18.20 GPa: 2 个新峰
  压力 21.50 GPa: 2 个新峰
  压力 25.00 GPa: 2 个新峰

>>> 新峰数量已稳定：2 个
  稳定新峰位置：[50.123, 53.245]

...
```

## 常见问题

### 1. 如何调整波长？

修改代码顶部的`WAVELENGTH`参数：
```python
WAVELENGTH = 1.5406  # 修改为你的波长值 (Å)
```

### 2. 程序识别不到相变点

- 尝试增大`PEAK_TOLERANCE_1`值（例如从0.3改为0.5）
- 检查CSV文件格式是否正确
- 确保不同压力点之间有空行分隔

### 3. 晶系判断结果不合理

- 检查波长设置是否正确
- 调整峰位容差参数
- 检查输入峰位数据的质量
- 可能需要更多的峰位数据以提高判断准确性

### 4. CSV文件格式错误

确保：
- 文件编码为UTF-8
- File列包含压力信息
- Center列包含峰位（2theta角度）
- 不同压力点之间有空行

### 5. 拟合残差很大

可能原因：
- 峰位数据质量较差
- 实际晶系不在预定义的晶系列表中
- hkl指标分配可能不正确

解决方法：
- 检查数据质量
- 手动指定hkl指标
- 增加更多峰位数据

## HKL指标说明

程序内置了各晶系按2theta从小到大的标准hkl顺序（前20个）：

### FCC (面心立方)
允许反射：h, k, l全为奇数或全为偶数
- (111), (200), (220), (311), (222), ...

### BCC (体心立方)
允许反射：h + k + l = 偶数
- (110), (200), (211), (220), (310), ...

### HCP (六方密堆积)
- (100), (002), (101), (102), (110), ...

**注意**：如果你的材料的hkl顺序与程序预设不同，可能需要修改`CRYSTAL_SYSTEMS`字典中的`hkl_list`。

## 进阶使用

### 在Python脚本中调用

```python
from phase_transition_analysis import analyze_phase_transition

# 执行分析
results = analyze_phase_transition('your_data.csv')

# 访问结果
print(f"相变压力: {results['transition_pressure']} GPa")
print(f"相变前晶系: {results['before_system']}")

for analysis in results['after_analysis']:
    print(f"压力 {analysis['pressure']} GPa:")
    print(f"  新相晶系: {analysis['new_phase_system']}")
    print(f"  晶胞参数: {analysis['new_phase_params']}")
```

### 自定义晶系hkl顺序

在代码中修改`CRYSTAL_SYSTEMS`字典：

```python
CRYSTAL_SYSTEMS['my_custom_phase'] = {
    'name': 'My Custom Phase',
    'min_peaks': 3,
    'hkl_list': [
        (1,0,0), (1,1,0), (1,1,1),
        # ... 添加更多hkl
    ]
}
```

## 参考文献

1. Cullity, B. D., & Stock, S. R. (2001). Elements of X-ray Diffraction (3rd ed.). Prentice Hall.
2. Warren, B. E. (1990). X-ray Diffraction. Dover Publications.
3. Giacovazzo, C. (2011). Fundamentals of Crystallography (3rd ed.). Oxford University Press.

## 联系方式

如有问题或建议，请联系：candicewang928@gmail.com

## 更新日志

### v1.0 (2025-11-12)
- 初始版本发布
- 支持7种晶系的自动识别
- 实现相变点自动检测
- 新峰统计和追踪功能
- 晶胞参数自动计算

---

**注意**：本程序用于辅助分析，结果仅供参考。建议结合其他表征手段（如Rietveld精修、电子显微镜等）进行验证。
